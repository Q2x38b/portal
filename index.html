<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow">
    <!-- Permissive CSP to allow rendering arbitrary widget code inside iframes. Tighten later if needed. -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' data: blob: https: http: 'unsafe-inline' 'unsafe-eval';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:;
      style-src 'self' 'unsafe-inline' https:;
      img-src 'self' data: blob: https: http:;
      font-src 'self' data: https:;
      frame-src *;
      connect-src *;
    ">
    <title>Secure Render</title>
    <style>
      :root {
        --background: #141414;
        --foreground: #ebebeb;
        --text-secondary: #a1a1aa;
        --border-color: #333;
        --hover-bg: rgba(255,255,255,0.06);
        --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      [data-theme="light"] {
        --background: #f7f7f7;
        --foreground: #101010;
        --text-secondary: #525252;
        --border-color: #ddd;
        --hover-bg: rgba(0,0,0,0.05);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--background);
        color: var(--foreground);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .center-screen {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: transparent;
        color: inherit;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        cursor: pointer;
      }
      button:hover { background: var(--hover-bg); }
      .container {
        max-width: 1700px;
        margin: 0 auto;
        padding: 1.25rem;
      }
      .heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 0;
        margin-bottom: 1.25rem;
      }
      .muted { color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.75rem; }
      .rendered-section { margin: 1rem 0 2rem; }
      .code-toggle { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; margin-bottom: 0.5rem; }
      .code-container { display: none; border: 1px solid var(--border-color); border-radius: 10px; padding: 0.75rem; overflow: auto; background: rgba(255,255,255,0.03); }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-family: var(--font-mono); font-size: 0.85rem; }
      .widget-container { border: 0; border-radius: 0; padding: 0; background: transparent; }
      /* Seamless look for injected content */
      .widget-container, .widget-container * { color: inherit; font-family: var(--font-sans); }
      .widget-container a { color: var(--text-secondary); }
      .widget-iframe { width: 100%; border: 0; min-height: 200px; }
      .plain-text { white-space: pre-wrap; word-break: break-word; font-size: 0.95rem; }
      /* Privacy overlay and print guard */
      .privacy-overlay { position: fixed; inset: 0; background: #ffffff; z-index: 999999; display: none; }
      .privacy-overlay.show { display: block; }
      @media print { body { display: none !important; } }
      iframe.secure-iframe { width: 100%; border: 0; min-height: 200px; }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <!-- Login screen -->
    <div id="login" class="center-screen" style="justify-content: center; align-items: center;">
      <button id="signin" disabled>Loadingâ€¦</button>
    </div>

    <!-- Main content -->
    <div id="app" style="display:none">
      <div class="container">
        <div class="heading">
          <div></div>
          <div>
            <button id="signout" style="display:none">Sign out</button>
          </div>
        </div>

        <div id="content-root"></div>
      </div>
    </div>

    <script>
      (function(){
      'use strict';
      // === Configuration: replace these with your values ===
      const CLIENT_ID = '936331083814-8hv2h12vfd021st5frrvhav875mucps3.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyApvQuAABFbVVDVWTOdVSrWWXhLAYeXyZo';
      const SPREADSHEET_ID = '1iEZUGIuFGsrknHVY7hHH7DMoQc87SZMMLMoxbIJ0nMo';
      // SHEET_RANGE can be either 'TabName!A:A' or just 'A:A'. If no tab name is included,
      // the first sheet's title will be auto-detected and used.
      const SHEET_RANGE = 'A:A';
      // Render only escaped plain text from column A (no script execution, no iframes)
      const RENDER_PLAIN_TEXT = true;

      // === Google API setup ===
      const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly openid email profile';
      const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];

      const loginEl = document.getElementById('login');
      const appEl = document.getElementById('app');
      const contentRoot = document.getElementById('content-root');
      const signInBtn = document.getElementById('signin');
      const signOutBtn = document.getElementById('signout');

      let tokenClient = null;
      let accessToken = null;

      function onLoad() {
        gapi.load('client', async () => {
          await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
          if (google?.accounts?.oauth2?.initTokenClient) {
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (resp) => {
                if (resp?.error) { console.error(resp); return; }
                accessToken = resp.access_token;
                gapi.client.setToken({ access_token: accessToken });
                // Expose token for in-page rendered snippets that need authenticated requests
                try { window.GOOGLE_ACCESS_TOKEN = accessToken; } catch (_) {}
                // Persist token for other pages (e.g., dashboard)
                try {
                  localStorage.setItem('googleAccessToken', accessToken);
                  localStorage.setItem('googleAccessTokenTime', String(Date.now()));
                } catch (_) {}
                loginEl.style.display = 'none';
                appEl.style.display = 'block';
                signOutBtn.style.display = 'inline-flex';
                // Move sign-in button to corner after login (keep for consistency if needed later)
                try { const btn = document.getElementById('signin'); if (btn) { btn.style.position = 'absolute'; btn.style.top = '12px'; btn.style.right = '16px'; } } catch(_){}
                fetchAndRender();
              },
            });
            // Enable the sign-in button only once token client is ready
            try { signInBtn.disabled = false; signInBtn.textContent = 'Sign in'; } catch (_) {}
          }
        });
      }

      function signIn() {
        if (!tokenClient) { console.error('Token client not ready'); return; }
        tokenClient.requestAccessToken();
      }

      function signOut() {
        if (!accessToken) { window.location.reload(); return; }
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = null;
          gapi.client.setToken(null);
          try { localStorage.removeItem('googleAccessToken'); localStorage.removeItem('googleAccessTokenTime'); } catch(_) {}
          appEl.style.display = 'none';
          contentRoot.innerHTML = '';
          signOutBtn.style.display = 'none';
          loginEl.style.display = 'flex';
          // Reload page after sign-out completes
          try { window.location.reload(); } catch(_) {}
        });
      }

      async function getFirstSheetTitle() {
        try {
          const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
          const title = meta?.result?.sheets?.[0]?.properties?.title;
          return title || 'Sheet1';
        } catch (e) {
          return 'Sheet1';
        }
      }

      async function resolveRange() {
        if (SHEET_RANGE.includes('!')) return SHEET_RANGE;
        const firstTitle = await getFirstSheetTitle();
        return `${firstTitle}!${SHEET_RANGE}`;
      }

      async function fetchAndRender() {
        try {
          const effectiveRange = await resolveRange();
          const resp = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: effectiveRange,
          });
          const rows = resp?.result?.values || [];
          renderRows(rows);
        } catch (err) {
          const msg = err?.result?.error?.message || err?.message || 'Unknown error';
          console.error('Sheets error', msg, err);
          contentRoot.innerHTML = `<div class="muted">Failed to load data: ${escapeHtml(String(msg))}</div>`;
        }
      }

      function renderRows(rows) {
        contentRoot.innerHTML = '';
        if (!rows.length) {
          contentRoot.innerHTML = '<div class="muted">No rows found.</div>';
          return;
        }

        const startIndex = (rows[0] && (rows[0][0] === 'HTML' || rows[0][0] === 'Content')) ? 1 : 0;
        for (let i = startIndex; i < rows.length; i++) {
          const raw = (rows[i] && rows[i][0]) ? String(rows[i][0]) : '';
          if (!raw || !raw.trim()) continue;

          // Unwrap and unescape typical CSV/Sheets quoting artifacts.
          let cellContent = raw;
          if (cellContent.startsWith('"') && cellContent.endsWith('"')) {
            cellContent = cellContent.slice(1, -1);
          }
          cellContent = cellContent.replace(/""/g, '"');

          const sectionId = `code-${i}`;

          const section = document.createElement('div');
          section.className = 'rendered-section';
          section.innerHTML = `
            <div class="widget-container"><div id="out-${i}" class="code-output"></div></div>
          `;
          contentRoot.appendChild(section);

          const out = section.querySelector(`#out-${i}`);
          // If it looks like HTML, inject and execute; otherwise render as escaped plain text
          if (isHtmlLike(cellContent)) {
            injectHtml(out, cellContent, i);
          } else {
            out.classList.add('plain-text');
            out.textContent = cellContent;
          }
        }
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function isHtmlLike(text) {
        try {
          if (!text) return false;
          if (/<!DOCTYPE/i.test(text)) return true;
          return /<\/?[a-z][\s\S]*>/i.test(text);
        } catch (_) {
          return false;
        }
      }

      function injectHtml(container, htmlString, index) {
        try {
          // Render inside a sandboxed iframe to reduce visibility to external scripts/extensions
          const iframe = document.createElement('iframe');
          iframe.className = 'secure-iframe';
          // No allow-same-origin to isolate DOM; allow only scripts/forms/pointer-lock
          iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-pointer-lock');
          iframe.srcdoc = String(htmlString || '');
          container.innerHTML = '';
          container.appendChild(iframe);
        } catch (e) {
          container.innerHTML = `<div class="muted">Render error: ${escapeHtml(String(e.message || e))}</div>`;
        }
      }

      // Privacy/anti-capture features
      const privacyOverlay = document.createElement('div');
      privacyOverlay.className = 'privacy-overlay';
      document.addEventListener('DOMContentLoaded', () => { try { document.body.appendChild(privacyOverlay); } catch(_) {} });
      function showPrivacyOverlay() { try { privacyOverlay.classList.add('show'); } catch(_) {} }
      function hidePrivacyOverlay() { try { privacyOverlay.classList.remove('show'); } catch(_) {} }
      // Show overlay when the tab is actually hidden; do not react to transient blur
      document.addEventListener('visibilitychange', () => { if (document.hidden) { showPrivacyOverlay(); } else { hidePrivacyOverlay(); } });
      // Ignore window blur from dropdowns/popups; only hide overlay on focus return
      window.addEventListener('focus', () => { hidePrivacyOverlay(); });
      // Block context menu and common capture/print shortcuts
      document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
      document.addEventListener('keydown', (e) => {
        // Block Print Screen
        if (e.key && e.key.toLowerCase() === 'printscreen') {
          e.preventDefault();
          try { navigator.clipboard && navigator.clipboard.writeText(''); } catch(_) {}
          showPrivacyOverlay();
          setTimeout(hidePrivacyOverlay, 1000);
        }
        // Block Ctrl/Cmd+P (print)
        if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
          e.preventDefault();
          showPrivacyOverlay();
          setTimeout(hidePrivacyOverlay, 800);
        }
        // Block Ctrl/Cmd+S (save page)
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) { e.preventDefault(); }
      });
      // Basic DevTools detection (heuristic) -> cover
      (function devtoolsGuard(){
        let lastState = false;
        function check() {
          const threshold = 160;
          const opened = (window.outerWidth - window.innerWidth > threshold) || (window.outerHeight - window.innerHeight > threshold);
          if (opened !== lastState) {
            lastState = opened; if (opened) showPrivacyOverlay(); else hidePrivacyOverlay();
          }
        }
        setInterval(check, 800);
      })();
      // Remove saved Google access token on reload/navigation
      window.addEventListener('beforeunload', () => { try { localStorage.removeItem('googleAccessToken'); localStorage.removeItem('googleAccessTokenTime'); } catch(_) {} });

      window.addEventListener('load', onLoad);
      signInBtn.addEventListener('click', signIn);
      signOutBtn.addEventListener('click', signOut);
      })();
    </script>
  </body>
  </html>
