<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow">
    <!-- Permissive CSP to allow rendering arbitrary widget code inside iframes. Tighten later if needed. -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' data: blob: https: http: 'unsafe-inline' 'unsafe-eval';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:;
      style-src 'self' 'unsafe-inline' https:;
      img-src 'self' data: blob: https: http:;
      font-src 'self' data: https:;
      frame-src *;
      connect-src *;
    ">
    <title>Secure Render</title>
    <style>
      :root {
        --background: #141414;
        --foreground: #ebebeb;
        --text-secondary: #a1a1aa;
        --border-color: #333;
        --hover-bg: rgba(255,255,255,0.06);
        --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      [data-theme="light"] {
        --background: #f7f7f7;
        --foreground: #101010;
        --text-secondary: #525252;
        --border-color: #ddd;
        --hover-bg: rgba(0,0,0,0.05);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--background);
        color: var(--foreground);
        font-family: var(--font-sans);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .center-screen {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: transparent;
        color: inherit;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        cursor: pointer;
      }
      button:hover { background: var(--hover-bg); }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1.25rem;
      }
      .heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1.25rem;
      }
      .muted { color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.75rem; }
      .rendered-section { margin: 1rem 0 2rem; }
      .code-toggle { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; margin-bottom: 0.5rem; }
      .code-container { display: none; border: 1px solid var(--border-color); border-radius: 10px; padding: 0.75rem; overflow: auto; background: rgba(255,255,255,0.03); }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-family: var(--font-mono); font-size: 0.85rem; }
      .widget-container { border: 1px solid var(--border-color); border-radius: 10px; padding: 0.75rem; background: rgba(0,0,0,0.08); }
      .widget-iframe { width: 100%; border: 0; min-height: 200px; }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <!-- Login screen -->
    <div id="login" class="center-screen">
      <button id="signin" disabled>Loadingâ€¦</button>
    </div>

    <!-- Main content -->
    <div id="app" style="display:none">
      <div class="container">
        <div class="heading">
          <div>
            <div style="font-weight:600; font-size: 1rem;">Secure Render</div>
            <div class="muted">Renders HTML from your Google Sheet (column A)</div>
          </div>
          <div>
            <button id="signout" style="display:none">Sign out</button>
          </div>
        </div>

        <div id="content-root"></div>
      </div>
    </div>

    <script>
      // === Configuration: replace these with your values ===
      const CLIENT_ID = '936331083814-8hv2h12vfd021st5frrvhav875mucps3.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyApvQuAABFbVVDVWTOdVSrWWXhLAYeXyZo';
      const SPREADSHEET_ID = '1iEZUGIuFGsrknHVY7hHH7DMoQc87SZMMLMoxbIJ0nMo';
      // SHEET_RANGE can be either 'TabName!A:A' or just 'A:A'. If no tab name is included,
      // the first sheet's title will be auto-detected and used.
      const SHEET_RANGE = 'A:A';
      // If true, render each cell inside an isolated iframe. If false, inject into the page so
      // scripts run in the same context (can reuse OAuth token). Disable iframe if your snippets
      // need authenticated Google calls.
      const RENDER_IN_IFRAME = false;

      // === Google API setup ===
      const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly openid email profile';
      const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];

      const loginEl = document.getElementById('login');
      const appEl = document.getElementById('app');
      const contentRoot = document.getElementById('content-root');
      const signInBtn = document.getElementById('signin');
      const signOutBtn = document.getElementById('signout');

      let tokenClient = null;
      let accessToken = null;

      function onLoad() {
        gapi.load('client', async () => {
          await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
          if (google?.accounts?.oauth2?.initTokenClient) {
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (resp) => {
                if (resp?.error) { console.error(resp); return; }
                accessToken = resp.access_token;
                gapi.client.setToken({ access_token: accessToken });
                // Expose token for in-page rendered snippets that need authenticated requests
                try { window.GOOGLE_ACCESS_TOKEN = accessToken; } catch (_) {}
                loginEl.style.display = 'none';
                appEl.style.display = 'block';
                signOutBtn.style.display = 'inline-flex';
                fetchAndRender();
              },
            });
            // Enable the sign-in button only once token client is ready
            try { signInBtn.disabled = false; signInBtn.textContent = 'Sign in'; } catch (_) {}
          }
        });
      }

      function signIn() {
        if (!tokenClient) { console.error('Token client not ready'); return; }
        tokenClient.requestAccessToken();
      }

      function signOut() {
        if (!accessToken) return;
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = null;
          gapi.client.setToken(null);
          appEl.style.display = 'none';
          contentRoot.innerHTML = '';
          signOutBtn.style.display = 'none';
          loginEl.style.display = 'flex';
        });
      }

      async function getFirstSheetTitle() {
        try {
          const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
          const title = meta?.result?.sheets?.[0]?.properties?.title;
          return title || 'Sheet1';
        } catch (e) {
          return 'Sheet1';
        }
      }

      async function resolveRange() {
        if (SHEET_RANGE.includes('!')) return SHEET_RANGE;
        const firstTitle = await getFirstSheetTitle();
        return `${firstTitle}!${SHEET_RANGE}`;
      }

      async function fetchAndRender() {
        try {
          const effectiveRange = await resolveRange();
          const resp = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: effectiveRange,
          });
          const rows = resp?.result?.values || [];
          renderRows(rows);
        } catch (err) {
          const msg = err?.result?.error?.message || err?.message || 'Unknown error';
          console.error('Sheets error', msg, err);
          contentRoot.innerHTML = `<div class="muted">Failed to load data: ${escapeHtml(String(msg))}</div>`;
        }
      }

      function renderRows(rows) {
        contentRoot.innerHTML = '';
        if (!rows.length) {
          contentRoot.innerHTML = '<div class="muted">No rows found.</div>';
          return;
        }

        const startIndex = (rows[0] && (rows[0][0] === 'HTML' || rows[0][0] === 'Content')) ? 1 : 0;
        for (let i = startIndex; i < rows.length; i++) {
          const raw = (rows[i] && rows[i][0]) ? String(rows[i][0]) : '';
          if (!raw || !raw.trim()) continue;

          // Unwrap and unescape typical CSV/Sheets quoting artifacts.
          let cellContent = raw;
          if (cellContent.startsWith('"') && cellContent.endsWith('"')) {
            cellContent = cellContent.slice(1, -1);
          }
          cellContent = cellContent.replace(/""/g, '"');

          const sectionId = `code-${i}`;
          const frameId = `frame-${i}`;

          const section = document.createElement('div');
          section.className = 'rendered-section';
          if (RENDER_IN_IFRAME) {
            section.innerHTML = `
              <div class="code-toggle" onclick="(function(){const el=document.getElementById('${sectionId}'); el.style.display = el.style.display==='block' ? 'none' : 'block';})()">Show/Hide Code</div>
              <div id="${sectionId}" class="code-container"><pre>${escapeHtml(cellContent)}</pre></div>
              <div class="widget-container"><iframe id="${frameId}" class="widget-iframe"></iframe></div>
            `;
          } else {
            const outputId = `out-${i}`;
            section.innerHTML = `
              <div class="code-toggle" onclick="(function(){const el=document.getElementById('${sectionId}'); el.style.display = el.style.display==='block' ? 'none' : 'block';})()">Show/Hide Code</div>
              <div id="${sectionId}" class="code-container"><pre>${escapeHtml(cellContent)}</pre></div>
              <div class="widget-container"><div id="${outputId}" class="code-output"></div></div>
            `;
          }
          contentRoot.appendChild(section);

          if (RENDER_IN_IFRAME) {
            // Write content into an about:blank iframe and auto-size it
            const iframe = section.querySelector(`#${frameId}`);
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(cellContent);
            doc.close();
            setTimeout(() => {
              try { iframe.style.height = (doc.body.scrollHeight + 20) + 'px'; } catch (_) {}
            }, 120);
          } else {
            // Inject into page context so scripts can run with same origin and access window.GOOGLE_ACCESS_TOKEN
            const out = section.querySelector(`#out-${i}`);
            out.innerHTML = cellContent;
            // Re-execute scripts
            const scripts = out.querySelectorAll('script');
            scripts.forEach((oldS) => {
              const s = document.createElement('script');
              // Copy attributes
              for (const attr of oldS.attributes) s.setAttribute(attr.name, attr.value);
              s.text = oldS.text;
              oldS.parentNode.replaceChild(s, oldS);
            });
          }
        }
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      window.addEventListener('load', onLoad);
      signInBtn.addEventListener('click', signIn);
      signOutBtn.addEventListener('click', signOut);
    </script>
  </body>
  </html>


